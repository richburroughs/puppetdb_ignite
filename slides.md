footer: Rich Burroughs, Daniel Parks - Puppet SRE
slidenumbers: true

^ To do :
^
^ Definition of PuppetDB - Rich
^ Service Discovery - Daniel
^ Queries in Puppet Code - Daniel
^ Requests - Rich
^ PQL

[.footer: ]
[.slidenumbers: false ]
# What Are You Running? PuppetDB Knows.

## Rich Burroughs, Daniel Parks
## Puppet SRE

---

## What is PuppetDB?
> "PuppetDB collects data generated by Puppet. It enables advanced Puppet features like exported resources, and can be the foundation for other applications that use Puppet’s data."

---

## How do I get it?
- Included with Puppet Enterprise
- Open source users can install the puppetlabs/puppetdb module to install and manage it

---

## Puppet Query Language (PQL)

---
```Ruby
inventory { certname ~ "^web" and facts.os.family = "Debian" }

resources { certname ~ "^db" and type = "Postgresql::Server::Database" }

reports { latest_report? = true and certname ~ "^lb" }
```

---
```Ruby
$ puppet query 'reports[certname,receive_time,environment] { certname = "lb2.example.com" and latest_report? = true }'

[
  {
    "certname": "lb2.example.com",
    "receive_time": "2017-07-21T23:04:11.932Z",
    "environment": "production"
  }
]
```
---

## Queries in Puppet Code

---

## Service Discovery

---

## REST API

---

^ Python's Requests library is great
^ Can also use libraries for other languages that do HTTP

![inline](images/requests_screenshot.png)

---

```Python
import requests

nodes = []

def get_nodes():
    url = "http://localhost:8080/pdb/query/v4/nodes"
    r = requests.get(url)
    response = json.loads(r.text)
    for i in response:
        if not i['deactivated'] and not i['expired']:
            nodes.append(i['certname'])
```

---

```Python
def get_fact(certname, fact):
    url = "http://localhost:8080/pdb/query/v4/nodes/{}/facts/{}".format(certname, fact)
    r = requests.get(url)
    response = json.loads(r.text)
    for i in response:
        result = i['value']
        return result
```

---

```Python
def main():
    get_nodes()
    for node in nodes:
        operatingsystem = get_fact(node, 'operatingsystem')
        operatingsystemrelease = get_fact(node, 'operatingsystemrelease')
        kernelversion = get_fact(node, 'kernelversion')
```
