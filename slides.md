footer: Rich Burroughs, Daniel Parks - Puppet SRE
slidenumbers: true

[.footer: ]
[.slidenumbers: false ]
# What Are You Running? PuppetDB Knows.

## Rich Burroughs, Daniel Parks
## Puppet SRE

### http://bit.ly/2uetA88
---

## What is PuppetDB?
> "PuppetDB collects data generated by Puppet. It enables advanced Puppet features like exported resources, and can be the foundation for other applications that use Puppet’s data."

---

## How do I get it?
- Included with Puppet Enterprise
- Open source users can use the puppetlabs/puppetdb module to install and manage it

---

## Puppet Query Language (PQL)

---
```Ruby
                inventory { certname ~ "prod" and facts.os.family = "Debian" }
```

---
```Ruby
$ puppet query 'inventory { certname ~ "prod" and facts.os.family = "Debian" }'
[
  {
    "certname": "web1-prod.example.com",
    "timestamp": "2017-03-22T19:36:20.095Z",
    "environment": "production",
    "facts": {
      "memoryfreeinbytes": "1766612992",
      "os": {
        "name": "Debian",
        "distro": {
          "id": "Debian",
          "release": {
            "full": "8.7",
            "major": "8",
            "minor": "7"
          },
          . . .
```
---
^ Returns file and line number where the resource is defined
^ Includes all parameters for the resource, including the ones that aren't directly specified and come from defaults or hiera
```Ruby
$ puppet query 'resources { type = "Postgresql::Server::Database" }'
[
  {
    "tags": [ . . . ],
    "file": "/etc/puppetlabs/code/ . . . /profile/manifests/database.pp",
    "type": "Postgresql::Server::Db",
    "title": "database",
    "line": 48,
    "certname": "db1-prod.example.com",
    "parameters": {
      "user": "myapp",
      "grant": "ALL",
      "owner": "myapp",
      "dbname": "myapp",
      "password": " . . . ",
      "template": "template0",
      "istemplate": false
      . . .
```
---

```Ruby
❯ puppet query 'resources[certname,environment,title]
  { type = "Class" and title ~ "Role::" }'
[
  {
    "certname": "web1-prod.example.com",
    "environment": "production",
    "title": "Role::Web"
  },
  {
    "certname": "db1-prod.example.com",
    "environment": "production",
    "title": "Role::Db"
  },
  {
    "certname": "web2-dev.example.com",
    "environment": "nginx_update",
    "title": "Role::Web"
    . . .
```
---

## Queries in Puppet Code

^ We can also PQL in Puppet code. We often use this instead of exported resources.
---

^ Here's an example of setting up hosts in our Icinga2 monitoring system.
^ We query for all nodes and create a host resource for them based on facts defined for each node.

``` puppet
puppetdb_query('inventory {}').each |$node| {
  $notification_period = 'allhours'




  icinga2::object::host { $node['trusted']['certname']:
    ipv4_address => $node['facts']['ipaddress'],
    vars         => {
      'owner'               => $node['facts']['owner'],
      'notification_period' => $notification_period,
    },
  }
}
```
---

^ Here's an advantage over exported resources.
^ If I want to test a change to the host object, I only have to run puppet on the master node instead of running it on the host and then then master.

``` puppet
puppetdb_query('inventory {}').each |$node| {
  $notification_period = $node['trusted']['hostname'] ? {
    /-prod$/  => 'allhours',
    /-stage$/ => 'workhours',
  }

  icinga2::object::host { $node['trusted']['certname']:
    ipv4_address => $node['facts']['ipaddress'],
    vars         => {
      'owner'               => $node['facts']['owner'],
      'notification_period' => $notification_period,
    },
  }
}
```
---

## Service Discovery

^ We use this pattern at Puppet a lot
^ for things like populating load balancers
^ and configuring monitoring

```puppet
puppetdb_query('inventory { certname ~ "^web" }').each |$node| {
  haproxy::balancermember { $node['facts']['fqdn']:
    listening_service => 'www',
    server_names      => $node['facts']['fqdn'],
    ipaddresses       => $node['facts']['ipaddress'],
    ports             => '80',
  }
}
```

---

## REST API

^ Can access via HTTP or HTTPS
^ If you use as part of PE, you can use RBAC auth tokens

---

^ Python's Requests library is great
^ Can also use libraries for other languages that do HTTP, like Ruby's rest-client

![inline](images/requests_screenshot.png)

---

```Python
def get_nodes():
    nodes = []
    url = "http://localhost:8080/pdb/query/v4/nodes"
    r = requests.get(url)
    response = json.loads(r.text)
    for i in response:
        if not i['deactivated'] and not i['expired']:
            nodes.append(i['certname'])
    return nodes
```

---

```Python
def get_fact(certname, fact):
    url = "http://localhost:8080/pdb/query/v4/nodes/{}/facts/{}".format(certname, fact)
    r = requests.get(url)
    response = json.loads(r.text)
    for i in response:
        result = i['value']
        return result
```

---

```Python
def main():
    get_nodes()
    for node in nodes:
        operatingsystem = get_fact(node, 'operatingsystem')
        operatingsystemrelease = get_fact(node, 'operatingsystemrelease')
        kernelversion = get_fact(node, 'kernelversion')
```
